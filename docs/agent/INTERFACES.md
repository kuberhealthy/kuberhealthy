# Interfaces

Kuberhealthy interacts with three primary surfaces: the Kubernetes API, HTTP
endpoints served from the controller pod, and environment variables used for
configuration.

## Kubernetes API

- **`HealthCheck` Custom Resource** (`pkg/api`)
  - Inputs: desired run interval, timeout, target `PodSpec`, optional metadata.
  - Outputs: status block populated with `OK`, error strings, run durations, and
    bookkeeping such as the authoritative pod and run UUID.
- **Legacy `KuberhealthyCheck` CRD** (`comcast.github.io/v1`, converted to
  `HealthCheck`)
  - Inputs: same core fields as the modern check along with legacy `podAnnotations`
    and `podLabels` blocks that are preserved during conversion.
  - Outputs: legacy checks persist status in the same format so the admission
    webhook can upgrade them to the v2 `HealthCheck` schema before the controller
    consumes them.
- **Pods**
  - Created by the controller for each check run using the embedded `PodSpec`.
  - Annotated with labels defined in `internal/kuberhealthy` to link the pod to
    the originating check and run.
- **Events**
  - The controller publishes Kubernetes events to describe failures and status
    transitions for each check.

## HTTP Endpoints

The HTTP server configured in `cmd/kuberhealthy/webserver.go` exposes:

- `GET /status` and `GET /json` – JSON summary of all checks.
- `GET /metrics` – Prometheus metrics generated by `internal/metrics`.
- `GET /healthz` – Liveness probe that verifies basic process health.
- `POST /check` and `POST /` – Reporting endpoint for check pods. Payload must
  include the run UUID and status information defined in `pkg/api`.
- `POST /api/run` – Triggers an immediate run of a specific check using
  the `HealthCheck` name (and accepting the legacy `khcheck` alias) plus a
  `namespace` query parameter.
- `GET /api/events` – Lists Kubernetes events for a `HealthCheck`.
- `GET /api/logs` and `GET /api/logs/stream` – Fetches or streams pod logs for a
  particular check run.
- `GET /openapi.yaml` and `GET /openapi.json` – Serves the OpenAPI schema.
- `POST /api/convert` – Admission webhook handled by `internal/webhook` for
  converting legacy checks to v2 `HealthCheck` resources.
- `POST /api/khjobconvert` – Admission webhook for converting legacy job-based
  checks handled by `internal/jobwebhook` into `HealthCheck` resources.

Static assets for the status UI are served from `/static/` and the root path `/`
returns the HTML interface unless a POST report is received.

## Environment Variables

The `Config` struct in `cmd/kuberhealthy/config.go` loads several environment
variables that tune runtime behavior. Notable entries include:

- `KH_LISTEN_ADDRESS` and `KH_LISTEN_ADDRESS_TLS` – Bind addresses for HTTP and
  HTTPS listeners.
- `KH_CHECK_REPORT_URL` – Base URL advertised to checker pods as the reporting
  endpoint.
- `KH_DEFAULT_RUN_INTERVAL` and `KH_DEFAULT_CHECK_TIMEOUT` – Defaults applied to
  checks when their manifests omit values.
- `KH_MAX_*` variables – Retention policies for job objects and pods.
- `KH_PROM_*` variables – Feature flags for Prometheus metrics labeling.
- `KH_TLS_CERT_FILE` and `KH_TLS_KEY_FILE` – Enable TLS serving when both are
  present.

Pods also rely on `POD_NAME` and `POD_NAMESPACE` for self-identification.
