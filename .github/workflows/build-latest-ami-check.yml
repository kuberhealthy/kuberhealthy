name: Build and Push AMI-Check Latest
on:
  push:
    branches:
    - master
    - release/*
    - docker-hub # for testing this build spec
    paths:
      - "cmd/ami-check/**"
env:
    IMAGE_NAME: ami-check
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4.2.2
    - name: dockerfile sweep for best practices
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: cmd/ami-check/Dockerfile
    - name: Set up QEMU ðŸ”€
      uses: docker/setup-qemu-action@v3.2.0 
    - name: Set up Docker Buildx ðŸ› 
      id: buildx 
      uses: docker/setup-buildx-action@v3.8.0
      with:
        driver-opts: network=host
    - name: Build and push to local registry ðŸ”¨
      uses: docker/build-push-action@v6
      with:
        context: docker/freshclam
        push: true
        tags: localhost:5000/kuberhealthy/ami-check:latest
    - name: Scan image ðŸ’‰
      uses: anchore/scan-action@v6
      id: scan
      with:
        image: "localhost:5000/kuberhealthy/ami-check:latest"
        fail-build: true
        severity-cutoff: critical
        output-format: table
    - name: Log into docker hub
      run: echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u integrii --password-stdin
    - name: Push new latest image
      run: make -C cmd/daemonset-check push
    - name: Push new latest image
      run: make -C cmd/ami-check push
